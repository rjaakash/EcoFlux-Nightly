name: Sync Beta

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # Checkout
      # -------------------------------------------------
      - uses: actions/checkout@v4

      # -------------------------------------------------
      # Tools
      # -------------------------------------------------
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl grep coreutils

      # -------------------------------------------------
      # Resolve latest folder (must start with number)
      # -------------------------------------------------
      - name: Resolve VLC version
        run: |
          set -e

          BASE_URL="https://get.videolan.org/testing/android/"

          VERSION=$(curl -s "$BASE_URL" \
            | grep -oP '(?<=href=")[0-9][^/"]*(?=/")' \
            | sort -V \
            | tail -n 1)

          if [ -z "$VERSION" ]; then
            echo "Failed to resolve VLC version"
            exit 1
          fi

          # Convert 3.7.0-Beta-3 -> 3.7.0 Beta 3
          DISPLAY_VERSION=$(echo "$VERSION" | sed 's/-Beta-/ Beta /g')

          echo "Resolved version: $VERSION"
          echo "Display version: $DISPLAY_VERSION"

          echo "VLC_VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "DISPLAY_VERSION=$DISPLAY_VERSION" >> "$GITHUB_ENV"
          echo "BASE_URL=$BASE_URL" >> "$GITHUB_ENV"

      # -------------------------------------------------
      # Download APK (handled by SH)
      # -------------------------------------------------
      - name: Sync Beta APK
        run: |
          chmod +x scripts/sync-beta.sh
          scripts/sync-beta.sh

      # -------------------------------------------------
      # Extract changelog (MATCH ENDING WITH DISPLAY VERSION)
      # -------------------------------------------------
      - name: Extract changelog
        run: |
          set -e

          NEWS_URL="https://code.videolan.org/videolan/vlc-android/raw/master/NEWS"
          VERSION="$DISPLAY_VERSION"

          curl -s "$NEWS_URL" > NEWS.txt

          awk -v ver="$VERSION" '
            /^Changes between/ {
              if (found) exit
              if ($0 ~ "and " ver ":$") found=1
            }
            found { print }
          ' NEWS.txt > CHANGELOG.txt

          if [ ! -s CHANGELOG.txt ]; then
            echo "Official changelog:" > CHANGELOG.txt
            echo "$NEWS_URL" >> CHANGELOG.txt
          fi

      # -------------------------------------------------
      # GitHub Release (PAT = YOU)
      # -------------------------------------------------
      - name: Create release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.ECOFLUX_GITHUB_PAT }}
        with:
          tag_name: ${{ env.VLC_VERSION }}
          name: ${{ env.DISPLAY_VERSION }}
          body_path: CHANGELOG.txt
          prerelease: true
          files: tmp/*.apk

      # -------------------------------------------------
      # Update beta.txt AFTER successful release
      # -------------------------------------------------
      - name: Update beta.txt
        if: success()
        run: |
          echo "$VLC_VERSION" > beta.txt

          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          git add beta.txt

          if git diff --cached --quiet; then
            exit 0
          fi

          git commit -m "chore(vlc): sync beta ${DISPLAY_VERSION}"
          git push
