name: Sync Nightly

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # Checkout
      # -------------------------------------------------
      - uses: actions/checkout@v4

      # -------------------------------------------------
      # Tools
      # -------------------------------------------------
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl grep coreutils

      # -------------------------------------------------
      # Resolve latest nightly APK
      # -------------------------------------------------
      - name: Resolve Nightly version
        run: |
          set -e

          BASE_URL="https://artifacts.videolan.org/vlc-android/nightly-arm64/"

          APK_NAME=$(curl -s "$BASE_URL" \
            | grep -o 'VLC-Android-[^"]*\.apk' \
            | sort \
            | tail -n 1)

          if [ -z "$APK_NAME" ]; then
            echo "Failed to resolve nightly APK"
            exit 1
          fi

          # Extract timestamp: 20260206-0120
          DISPLAY_VERSION=$(echo "$APK_NAME" | grep -o '[0-9]\{8\}-[0-9]\{4\}')

          echo "APK name       : $APK_NAME"
          echo "Display version: $DISPLAY_VERSION"

          echo "APK_NAME=$APK_NAME" >> "$GITHUB_ENV"
          echo "DISPLAY_VERSION=$DISPLAY_VERSION" >> "$GITHUB_ENV"
          echo "BASE_URL=$BASE_URL" >> "$GITHUB_ENV"

      # -------------------------------------------------
      # Download APK (handled by SH)
      # -------------------------------------------------
      - name: Sync Nightly APK
        run: |
          chmod +x scripts/sync-nightly.sh
          scripts/sync-nightly.sh

      # -------------------------------------------------
      # GitHub Release
      # -------------------------------------------------
      - name: Create release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.ECOFLUX_GITHUB_PAT }}
        with:
          tag_name: ${{ env.DISPLAY_VERSION }}
          name: ${{ env.DISPLAY_VERSION }}
          body: |
            Source Code - https://code.videolan.org/videolan/vlc-android
          files: tmp/*.apk

      # -------------------------------------------------
      # Update nightly.txt AFTER successful release
      # -------------------------------------------------
      - name: Update nightly.txt
        if: success()
        run: |
          echo "$APK_NAME" > nightly.txt

          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          git add nightly.txt

          if git diff --cached --quiet; then
            exit 0
          fi

          git commit -m "chore(vlc): sync nightly ${APK_NAME}"
          git push
